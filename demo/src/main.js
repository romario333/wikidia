define("model/diagram",["require"],function(a){return function(){var a={},b=[],c=[],d=[],e=!0,f=0;return a.addItem=function(c){if(!c.isLine&&!c.isNode)throw new Error("Only nodes and lines can be added to diagram");c.id=++f,c.isLine&&c.points().forEach(function(a){a.id=++f}),b.push(c),e&&a.fireItemAdded(c)},a.removeItem=function(c){if(!c.isLine&&!c.isNode)throw new Error("Only nodes and lines can be removed from diagram");var d=b.indexOf(c);if(d===-1)throw new Error("Item '{itemId}' not found in diagram.".supplant({itemId:c.id}));c.disconnect(),b.splice(d,1),c.id=null,c.isLine&&c.points().forEach(function(a){a.id=null}),e&&a.fireItemRemoved(c)},a.items=function(){return b},a.changeEventsEnabled=function(a){if(arguments.length===0)return e;e=a},a.itemAdded=function(a){c.push(a)},a.itemRemoved=function(a){d.push(a)},a.fireItemAdded=function(b){c.forEach(function(c){c(a,b)})},a.fireItemRemoved=function(b){d.forEach(function(c){c(a,b)})},a.toJSON=function(){var a="[";return b.forEach(function(c,d){a+=c.toJSON(),d<b.length-1&&(a+=", ")}),a+="]",a},a}}),define("utils",["require"],function(a){return String.prototype.supplant||(String.prototype.supplant=function(a){return this.replace(/\{([^\{\}]*)\}/g,function(b,c){var d=a[c];return typeof d=="string"||typeof d=="number"?d:b})}),{objectWithId:function b(){return b.lastId||(b.lastId=0),b.lastId++,{oid:b.lastId}},addObservableProperty:function(a,b,c){Object.defineProperty(a,b,{get:function(){return a["__"+b]},set:function(c){var d=a["__"+b];c!==d&&a.changeEventsEnabled()&&a.fireChange(),a["__"+b]=c}}),a["__"+b]=c},copyShallow:function(a){return jQuery.extend({},a)},copyDeep:function(a){return jQuery.extend(!0,{},a)}}}),define("model/item",["require","utils"],function(a){return function(b){var c=a("utils"),d=c.objectWithId(),e=[],f=[],g=!0;return d.id=null,d.change=function(a){f.push(a)},d.changeEventsEnabled=function(a){if(arguments.length===0)return g;g=a},d.fireChange=function(){f.forEach(function(a){a(d)})},d._addConnection=function(a){if(!a.id)throw new Error("Cannot add connection to item, it has no id set.");e.push(a),d.changeEventsEnabled()&&d.fireChange()},d.addConnection=function(a){d._addConnection(a),a._addConnection(d)},d._removeConnection=function(a){var b=e.indexOf(a);if(b===-1)throw new Error("Item '{itemId}' not found in connections of item '{thisId}'.".supplant({itemId:a.id,thisId:d.id}));e.splice(b,1),d.changeEventsEnabled()&&d.fireChange()},d.removeConnection=function(a){d._removeConnection(a),a._removeConnection(d)},d.connections=function(){return arguments.length===1?e[arguments[0]]:e.slice()},d.disconnect=function(){d.connections().forEach(function(a){d.removeConnection(a)})},d._test={onChangeHandlers:f},d}}),define("model/line",["require","model/item","utils"],function(a){var b=a("model/item"),c=a("utils");return function(a){function f(a,d){var e=b();return c.addObservableProperty(e,"x",a.x||0),c.addObservableProperty(e,"y",a.y||0),e.isLinePoint=!0,e.line=d,e.change=function(){throw new Error("You can't use change observing properties on point, use properties on line instead.")},e.fireChange=d.fireChange,e.changeEventsEnabled=function(){if(arguments.length!==0)throw new Error("You can't use change observing properties on point, use properties on line instead.");return d.changeEventsEnabled()},e}var d=b(),e=[];return a=a||{},e.push(f({x:a.x1||0,y:a.y1||0},d)),e.push(f({x:a.x2||0,y:a.y2||0},d)),c.addObservableProperty(d,"text",a.text||""),c.addObservableProperty(d,"kind",a.kind||"line"),d.points=function(a){return arguments.length===0?e.slice():e[a]},d.pointAt=function(a,b){for(var c=0;c<e.length;c++){var f=e[c];if(f.x===a&&f.y===b)return f}throw new Error("Point [{x}, {y}] not found on line with id '{line}'.".supplant({x:a,y:b,line:d.id}))},d.addConnection=function(a){throw new Error("You can't connect to line directly, use function on its point instead.")},d.removeConnection=function(a){throw new Error("You can't disconnect from line directly, use function on its point instead.")},d.connections=function(){throw new Error("You can't get list of line connections directly, use function on its point instead.")},d.disconnect=function(){d.points().forEach(function(a){a.connections().forEach(function(b){a.removeConnection(b)})})},d.isLine=!0,d}}),define("model/node",["require","model/item","utils"],function(a){var b=a("model/item"),c=a("utils");return function(a){var d=90,e=b();return a=a||{},c.addObservableProperty(e,"text",a.text||""),c.addObservableProperty(e,"x",a.x||0),c.addObservableProperty(e,"y",a.y||0),c.addObservableProperty(e,"width",a.width||d),c.addObservableProperty(e,"height",a.height||d),c.addObservableProperty(e,"kind",a.kind||"node"),e.isNode=!0,e}}),define("model",["require","model/diagram","model/line","model/node"],function(a){return{diagram:a("model/diagram"),line:a("model/line"),node:a("model/node")}}),define("view/svg/svgHelper",["require"],function(a){var b="http://www.w3.org/2000/svg";return{createSvgElement:function(a,c){var d=$(document.createElementNS(b,a));return c&&d.attr(c),d},pathBuilder:function(){var a=this.createSvgElement("path"),b="";return{moveTo:function(a,c){return b+="M {x} {y}".supplant({x:a,y:c}),this},lineTo:function(a,c){return b+="L {x} {y}".supplant({x:a,y:c}),this},attr:function(b){return a.attr(b),this},create:function(){return a.attr("d",b),a}}},printSvg:function(a){var b="",c;if(a.length)for(c=0;c<a.length;c++)b+=this.printSvg(a[c]);else{var d=a;if(!(d instanceof SVGElement))throw new Error("'{element}' is not a SVG element.".supplant({element:d}));b="<"+d.tagName;var e;for(c=0;c<d.attributes.length;c++)e=d.attributes[c],b+=' {name}="{value}"'.supplant(e);b+=">";for(c=0;c<d.childNodes.length;c++)b+=this.printSvg(d.childNodes[c]);b+="</"+d.tagName+">"}return b}}}),define("view/svg/viewBase",["require","./svgHelper"],function(a){return function(b){var c=a("./svgHelper"),d={},e,f,g,h;return b.click(function(a){a.stopPropagation(),e&&e(d)}),b.dblclick(function(a){a.stopPropagation(),f&&f(d)}),b.mousedown(function(a){a.stopPropagation(),g&&g(d)}),b.mouseup(function(a){h&&h(d)}),d.click=function(a){e=a},d.doubleClick=function(a){f=a},d.mouseDown=function(a){g=a},d.mouseUp=function(a){h=a},d.element=function(){return b},d.previewMove=function(a,c){b.attr("transform","translate({dx},{dy})".supplant({dx:a,dy:c}))},d.cancelPreviewMove=function(){b.removeAttr("transform")},d.createElement=function(a,d){var e=c.createSvgElement(a,d);return b.append(e),e},d.remove=function(){b.remove()},d}}),define("view/svg/rootView",["require","./viewBase","./svgHelper"],function(a){return function(b){var c=a("./viewBase"),d=a("./svgHelper"),e=$(d.createSvgElement("svg")),f=c(e);return b.append(e),f.containerWidth=function(){return b.width()},f.containerHeight=function(){return b.height()},f._test={svg:function(){return d.printSvg(e)}},f}}),define("view/svg/diagramView",["require","./viewBase","./svgHelper"],function(a){return function(b){function i(){g=f.createElement("rect",{"class":"eventBox",opacity:0,fill:"blue",width:"100%",height:"100%"}),h=f.createElement("g",{"class":"grid"}),e.css("-webkit-user-select","none"),e.css("-khtml-user-select","none"),e.css("-o-user-select","none"),e.css("user-select","none")}var c=a("./viewBase"),d=a("./svgHelper"),e=b.createElement("g",{"class":"diagram"}),f=c(e),g,h;return f.gridStep=0,f.update=function(){h.empty();if(f.gridStep!==0){var a=b.containerWidth(),c=b.containerHeight(),e,g,i;for(e=0;e<a;e+=f.gridStep)i=d.createSvgElement("line",{x1:e,y1:0,x2:e,y2:c,stroke:"blue",opacity:.5}),h.append(i);for(g=0;g<c;g+=f.gridStep)i=d.createSvgElement("line",{x1:0,y1:g,x2:a,y2:g,stroke:"blue",opacity:.5}),h.append(i)}},i(),f}}),define("view/svg/dragEventHandler",["require"],function(a){return function(a){function k(a){i&&l(),i=$(a),i.data("events")&&i.data("events").click&&(j=i.data("events").click.slice()),i.off("click")}function l(){j&&(j.forEach(function(a){i.on(a.type,a.selector,a.data,a.handler)}),i=undefined,j=undefined)}var b=!1,c=!1,d,e,f,g,h;a.mousedown(function(a){d=a.clientX,e=a.clientY,b=!0}),$(document.body).mousemove(function(a){b&&(c=!0,b=!1,f&&f(a),k(a.target));if(c&&g){var h=a.clientX-d,i=a.clientY-e;g(a,h,i)}}),$(document).mouseup(function(a){b=!1;if(c){c=!1;if(h){var f=a.clientX-d,g=a.clientY-e;h(a,f,g)}$(a.target).one("click",function(a){a.stopImmediatePropagation()}),l()}});var i,j,m={dragStart:function(a){f=a},dragMove:function(a){g=a},dragEnd:function(a){h=a}};return m}}),define("view/svg/nodeView",["require","./viewBase","./svgHelper","./dragEventHandler"],function(a){return function(b){function B(){g.attr("cursor","move"),i=h.createElement("g",{"class":"content"}),j=h.createElement("rect",{"class":"eventBox",opacity:0,fill:"blue"}),k=h.createElement("g",{"class":"resize-border",display:"none"}),l=h.createElement("circle",{"class":"connect-point",cx:0,cy:0,r:6,fill:"red",stroke:"blue",display:"none"}),l.attr("cursor","default");var a=f(g);a.dragStart(function(a){!z&&!A&&m&&m(h)}),a.dragMove(function(a,b,c){!z&&!A&&n&&n(h,b,c)}),a.dragEnd(function(a,b,c){!z&&!A&&o&&o(h,b,c)});var b=f(l);b.dragStart(function(a){A=!0;if(s){var b=a.target.cx.baseVal.value,c=a.target.cy.baseVal.value;s(h,b,c)}}),b.dragMove(function(a,b,c){t&&t(h,b,c)}),b.dragEnd(function(a,b,c){A=!1,u&&u(h,b,c)}),l.mouseup(function(a){if(v){var b=a.target.cx.baseVal.value,c=a.target.cy.baseVal.value;v(h,b,c)}}),g.mouseenter(function(a){!z&&w&&w(h)}),g.mouseleave(function(a){!z&&x&&x(h)}),g.mousemove(function(a){!z&&y&&y(h,a.offsetX,a.offsetY)})}function C(a){k.empty(),k.append(e.createSvgElement("rect",{x:a.x-2,y:a.y-2,width:a.width+4,height:a.height+4,fill:"none",stroke:"black","stroke-dasharray":"4,4"}));var b=e.pathBuilder().moveTo(a.x+a.width,a.y+a.height-c).lineTo(a.x+a.width,a.y+a.height).lineTo(a.x+a.width-c,a.y+a.height).attr({"stroke-width":7,stroke:"red",opacity:0,fill:"none",cursor:"se-resize"}).create();k.append(b);var d=f(b);d.dragStart(function(a){z=!0,p&&p(h)}),d.dragMove(function(a,b,c){q&&q(h,b,c)}),d.dragEnd(function(a,b,c){z=!1,r&&r(h,b,c)})}function D(a){var b=e.createSvgElement("text",{x:a.x,y:a.y,"alignment-baseline":"text-before-edge"}),c=a.lines||[a.text];return c.forEach(function(c){var d=e.createSvgElement("tspan",{x:a.x,dy:15});d.text(c),b.append(d)}),b}var c=15,d=a("./viewBase"),e=a("./svgHelper"),f=a("./dragEventHandler"),g=b.createElement("g",{"class":"node"}),h=d(g),i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=!1,A=!1;return h.showResizeBorder=function(){k.attr("display","block")},h.hideResizeBorder=function(){k.attr("display","none")},h.dragStart=function(a){m=a},h.dragMove=function(a){n=a},h.dragEnd=function(a){o=a},h.resizeDragStart=function(a){p=a},h.resizeDragMove=function(a){q=a},h.resizeDragEnd=function(a){r=a},h.connectPointDragStart=function(a){s=a},h.connectPointDragMove=function(a){t=a},h.connectPointDragEnd=function(a){u=a},h.connectPointMouseUp=function(a){v=a},h.mouseEnter=function(a){w=a},h.mouseLeave=function(a){x=a},h.mouseMove=function(a){y=a},h.showConnectionPoint=function(a){l.attr({cx:a.x,cy:a.y,display:"block"})},h.hideConnectionPoints=function(){l.attr({display:"none"})},h.updateView=function(a){C(a),j.attr({x:a.x-5,y:a.y-5,width:a.width+10,height:a.height+10})},h.isSelected=function(a){j.attr("opacity",a?.5:0)},h.clear=function(){i.empty()},h.rect=function(a){var b=e.createSvgElement("rect",a);i.append(b)},h.line=function(a){var b=e.createSvgElement("line",a);i.append(b)},h.ellipse=function(a){var b=e.createSvgElement("ellipse",a);i.append(b)},h.text=function(a){var b=D(a);return i.append(b),{width:b.width(),height:b.height()}},h.measureText=function(a){var b=D(a);i.append(b);var c={width:b.width(),height:b.height()};return b.remove(),c},h._test={},h._test.contentSvg=function(){var a="",b,c=i[0];for(b=0;b<c.childNodes.length;b++)a+=e.printSvg(c.childNodes[b]);return a},B(),h}}),define("view/svg/lineView",["require","./viewBase","./svgHelper","./dragEventHandler"],function(a){return function(b){function s(){h=g.createElement("g",{"class":"content"}),i=g.createElement("line",{"class":"eventBox",stroke:"blue",opacity:0,"stroke-width":7}),j=g.createElement("g",{"class":"connect-points"}),j.attr("cursor","default"),f.mouseenter(function(a){!n&&p&&p(g)}),f.mouseleave(function(a){!n&&q&&q(g)}),f.mousemove(function(a){!n&&r&&r(g,a.offsetX,a.offsetY)});var a=e(j);a.dragStart(function(a){n=!0;if(k){var b=a.target.cx.baseVal.value,c=a.target.cy.baseVal.value;k(g,b,c)}}),a.dragMove(function(a,b,c){l&&l(g,b,c)}),a.dragEnd(function(a,b,c){n=!1,m&&m(g,b,c)}),j.mouseup(function(a){if(o){var b=a.target.cx.baseVal.value,c=a.target.cy.baseVal.value;o(g,b,c)}})}var c=a("./viewBase"),d=a("./svgHelper"),e=a("./dragEventHandler"),f=b.createElement("g",{"class":"line"}),g=c(f),h,i,j,k,l,m,n=!1,o,p,q,r;return g.updateView=function(a){i.attr(a)},g.isSelected=function(a){i.attr("opacity",a?.5:0)},g.clear=function(){h.empty()},g.line=function(a){var b=d.createSvgElement("line",a);h.append(b)},g.showConnectionPoints=function(a){a.forEach(function(a){var b=d.createSvgElement("circle",{cx:a.x,cy:a.y,r:6,fill:"red",stroke:"blue"});j.append(b)})},g.hideConnectionPoints=function(){j.empty()},g.connectPointDragStart=function(a){k=a},g.connectPointDragMove=function(a){l=a},g.connectPointDragEnd=function(a){m=a},g.connectPointMouseUp=function(a){o=a},g.mouseEnter=function(a){p=a},g.mouseLeave=function(a){q=a},g.mouseMove=function(a){r=a},s(),g}}),define("view",["require","view/svg/rootView","view/svg/diagramView","view/svg/nodeView","view/svg/lineView"],function(a){return{rootView:a("view/svg/rootView"),diagramView:a("view/svg/diagramView"),nodeView:a("view/svg/nodeView"),lineView:a("view/svg/lineView")}}),define("presenter/commands",["require","model"],function(a){function c(a,b,c){function d(a){b[a.id]||(b[a.id]=a)}c.forEach(function(b){if(b.data.isNode){var c=b.data;a.push(c),c.connections().forEach(function(a){a.isLinePoint&&d(a)})}else{if(!b.data.isLine)throw new Error("Don't know how to handle this item.");b.data.points().forEach(function(a){d(a)})}})}var b=a("model");return{moveCommand:function(a){function i(a,b){f.forEach(function(c){c.changeEventsEnabled(!1),c.x+=a,c.y+=b,c.changeEventsEnabled(!0),c.fireChange()}),j(a,b)}function j(a,b){g.forEach(function(c){c.line.changeEventsEnabled(!1),c.x+=a,c.y+=b,c.line.changeEventsEnabled(!0),c.line.fireChange()})}function k(){a.forEach(function(a){a.data.isNode&&a.view.previewMove(b.dx,b.dy)}),j(b.dx-d,b.dy-e)}function l(){a.forEach(function(a){a.data.isNode&&a.view.cancelPreviewMove()}),j(-b.dx,-b.dy)}var b={},d=0,e=0,f=[],g=[];b.dx=0,b.dy=0,b.isMoveCommand=!0;var h=!0;return c(f,g,a),b.preview=function(){h?k():i(b.dx-d,b.dy-e),d=b.dx,e=b.dy},b.cancelPreview=function(){h?l():i(-b.dx,-b.dy)},b.execute=function(){i(b.dx,b.dy)},b.undo=function(){return i(-b.dx,-b.dy),a},b},resizeNodeCommand:function(a){function h(a,b){f.forEach(function(c){c.changeEventsEnabled(!1),c.width+=a,c.height+=b,c.changeEventsEnabled(!0),c.fireChange()}),g.forEach(function(c){c.line.changeEventsEnabled(!1),c.x+=a,c.y+=b,c.line.changeEventsEnabled(!0),c.line.fireChange()})}var b={},d=0,e=0,f=[],g=[];return b.dWidth=0,b.dHeight=0,b.isResizeNodeCommand=!0,c(f,g,a),b.preview=function(){h(b.dWidth-d,b.dHeight-e),d=b.dWidth,e=b.dHeight},b.cancelPreview=function(){h(-b.dWidth,-b.dHeight)},b.execute=function(){h(b.dWidth,b.dHeight)},b.undo=function(){return h(-b.dWidth,-b.dHeight),a},b},createLineCommand:function(a,c,d,e){var f={},g;return f.x1=d,f.y1=e,f.x2=d,f.y2=e,f.itemToConnect=null,g=b.line(),a.addItem(g),f.preview=function(){g.changeEventsEnabled(!1),g.points(0).x=f.x1,g.points(0).y=f.y1,g.points(1).x=f.x2,g.points(1).y=f.y2,g.changeEventsEnabled(!0),g.fireChange()},f.cancelPreview=function(){},f.execute=function(){g.changeEventsEnabled(!1),g.points(0).x=f.x1,g.points(0).y=f.y1,g.points(1).x=f.x2,g.points(1).y=f.y2,g.points(0).addConnection(c),f.itemToConnect&&g.points(1).addConnection(f.itemToConnect),g.changeEventsEnabled(!0),g.fireChange()},f.undo=function(){return[]},f},moveLinePointCommand:function(a){function f(b,c){a.line.changeEventsEnabled(!1),a.x+=b,a.y+=c,a.line.changeEventsEnabled(!0),a.line.fireChange()}var b={},c=0,d=0,e;b.dx=0,b.dy=0,b.connectToItem=null;if(a.connections().length>1)throw new Error("More that one connection on point '{id}'.".supplant(a));return a.connections().length===1&&(e=a.connections(0)),b.preview=function(){f(b.dx-c,b.dy-d),c=b.dx,d=b.dy},b.cancelPreview=function(){f(-b.dx,-b.dy)},b.execute=function(){f(b.dx,b.dy),a.line.changeEventsEnabled(!1),e&&a.removeConnection(e),b.connectToItem&&a.addConnection(b.connectToItem),a.line.changeEventsEnabled(!0),a.line.fireChange()},b.undo=function(){return f(-b.dx,-b.dy),a.line.changeEventsEnabled(!1),e&&a.addConnection(e),b.connectToItem&&a.removeConnection(b.connectToItem),a.line.changeEventsEnabled(!0),a.line.fireChange(),[]},b},editItemCommand:function(a){var b={},c=a.data.text;return b.newText=c,b.isEditItemCommand=!0,b.execute=function(){a.data.text=b.newText},b.undo=function(){return a.data.text=c,[a]},b.hasChanged=function(){return b.newText!==a.data.text},b},deleteItemsCommand:function(a,b){var c={},d=[];return c.execute=function(){b.forEach(function(b){var c=b.data;c.isLine?c.points().forEach(function(a){a.connections().forEach(function(b){d.push({from:a,to:b})})}):c.connections().forEach(function(a){d.push({from:c,to:a})}),a.removeItem(c)})},c.undo=function(){return b.forEach(function(b){a.addItem(b.data)}),d.forEach(function(a){a.from.addConnection(a.to)}),b},c}}}),define("presenter/renderers",["require","utils"],function(a){function c(a){return{rect:function(c){c=c?b.copyShallow(c):{},a.rect(c)},line:function(c){c=c?b.copyShallow(c):{},a.line(c)},text:function(c){return c=c?b.copyShallow(c):{},a.text(c)}}}function d(a){var b=0,c=4;return{rect:function(a){throw new Error("Not supported right now.")},line:function(d){d.y1||(d.y1=b),d.y2||(d.y2=b),d.y1+=c,d.y2+=c,a.line(d)},text:function(d){d.y||(d.y=b),d.x=d.x?d.x+c:c,d.y+=c;var e=a.text(d);return b+=e.height+c,e}}}function e(a,b,c){return{rect:function(d){return d.x=d.x?d.x+b:b,d.y=d.y?d.y+c:c,a.rect(d)},line:function(d){return d.x1=d.x1?d.x1+b:b,d.y1=d.y1?d.y1+c:c,d.x2=d.x2?d.x2+b:b,d.y2=d.y2?d.y2+c:c,a.line(d)},text:function(d){return d.x=d.x?d.x+b:b,d.y=d.y?d.y+c:c,a.text(d)}}}function f(a){var b={lines:[],properties:{}},c=a.split("\n");return c.forEach(function(a){var c=a.match(/^\{\{([^=]+)=([^}]+)\}\}$/);c===null?b.lines.push(a):b.properties[c[1]]=c[2]}),b}var b=a("utils");return{nodeRenderer:function(){var a={};return a.TEXT_PADDING=5,a._render=function(a){var b=a.data,c=a.view;c.clear(),c.updateView({x:b.x,y:b.y,width:b.width,height:b.height}),c.isSelected(a.isSelected);var d=f(b.text),e=d.properties.fill||"white",g=d.properties.stroke||"black";return{lines:d.lines,properties:d.properties,fillColor:e,strokeColor:g}},a.render=function(b){var f=a._render(b),g=b.data,h=b.view;h.rect({x:g.x,y:g.y,width:g.width,height:g.height,rx:3,ry:3,fill:f.fillColor,stroke:f.strokeColor});var i=c(d(e(h,g.x,g.y)));i.text({lines:f.lines})},a.showNearbyConnectionPoint=function(a,b,c,d,e){var f,g,h,i,j,k=[];Math.abs(c-a.x)<e&&(i=Math.floor(d/e)*e,j=i+e,k.push({x:a.x,y:i}),k.push({x:a.x,y:j})),Math.abs(c-(a.x+a.width))<e&&(i=Math.floor(d/e)*e,j=i+e,k.push({x:a.x+a.width,y:i}),k.push({x:a.x+a.width,y:j})),Math.abs(d-a.y)<e&&(g=Math.floor(c/e)*e,h=g+e,k.push({x:g,y:a.y}),k.push({x:h,y:a.y})),Math.abs(d-(a.y+a.height))<e&&(g=Math.floor(c/e)*e,h=g+e,k.push({x:g,y:a.y+a.height}),k.push({x:h,y:a.y+a.height}));var l=Infinity;k.forEach(function(a){var b=Math.pow(Math.abs(a.x-c),2)+Math.pow(Math.abs(a.y-d),2);b<l&&(f=a,l=b)}),b.hideConnectionPoints(),f&&b.showConnectionPoint(f)},a},classNodeRenderer:function(){var a=this.nodeRenderer();return a.render=function(b){var f=a._render(b),g=b.data,h=b.view;h.rect({x:g.x,y:g.y,width:g.width,height:g.height,rx:3,ry:3,fill:f.fillColor,stroke:f.strokeColor});var i=c(d(e(h,g.x,g.y)));f.lines.forEach(function(a){a==="--"?i.line({x1:0,x2:g.width,stroke:f.strokeColor}):i.text({text:a})})},a},useCaseNodeRenderer:function(){var a=this.nodeRenderer();return a.render=function(b){var f=a._render(b),g=b.data,h=b.view,i=g.width/2,j=g.height/2;h.ellipse({cx:g.x+i,cy:g.y+j,rx:i,ry:j,fill:f.fillColor,stroke:f.strokeColor});var k=c(d(e(h,g.x,g.y))),l=h.measureText({lines:f.lines}),m=0;g.width>l.width&&(m=(g.width-l.width)/2);var n=0;g.height>l.height&&(n=(g.height-l.height)/2),k.text({x:m,y:n,lines:f.lines})},a},lineRenderer:function(){var a={};return a.render=function(a){var b=a.data,c=a.view;c.clear(),c.updateView({x1:b.points(0).x,y1:b.points(0).y,x2:b.points(1).x,y2:b.points(1).y}),c.isSelected(a.isSelected),c.line({x1:b.points(0).x,y1:b.points(0).y,x2:b.points(1).x,y2:b.points(1).y,stroke:"black"})},a}}}),define("presenter/commandExecutor",["require"],function(a){return function(){var a={},b=[];return a.execute=function(a){b.push(a),a.execute()},a.undo=function(a){if(b.length>0)return b.pop().undo()},a}}),define("presenter/diagramPresenter",["require","view","presenter/commands","presenter/renderers","presenter/commandExecutor","utils"],function(a){var b=a("view"),c=a("presenter/commands"),d=a("presenter/renderers"),e=a("presenter/commandExecutor");return function(f,g,h){function s(){m=e(),f.gridStep=k,f.update(),f.click(A),g.items().forEach(function(a){if(a.isNode)t(a);else{if(!a.isLine)throw new Error("Don't know what this item is: "+a.kind);u(a)}}),g.itemAdded(w),g.itemRemoved(x),h.focus(F),h.blur(G),n.forEach(function(a){v(a)}),o=cb(),$(document).keydown(function(a){a.which===17&&(q=!0)}),$(document).keyup(function(a){a.ctrlKey&&(q=!1);if(a.ctrlKey===!0&&a.which===90){var b=m.undo();o.select(b)}if(a.which===46&&o.items().length>0){var d=c.deleteItemsCommand(g,o.items());m.execute(d)}})}function t(a){var c=b.nodeView(f),d=i.objectWithId();return d.data=a,d.view=c,d.isSelected=!1,n.push(d),a.change(y),c.mouseDown(B),c.click(C),c.doubleClick(D),c.dragStart(H),c.dragMove(I),c.dragEnd(J),c.resizeDragStart(K),c.resizeDragMove(L),c.resizeDragEnd(M),c.connectPointDragStart(N),c.connectPointDragMove(O),c.connectPointDragEnd(Q),c.connectPointMouseUp(P),c.mouseEnter(R),c.mouseLeave(S),c.mouseMove(T),d}function u(a){var c=b.lineView(f),d=i.objectWithId();return d.data=a,d.view=c,d.isSelected=!1,n.push(d),a.change(z),c.mouseDown(B),c.click(C),c.doubleClick(D),c.mouseEnter(Y),c.mouseLeave(Z),c.connectPointDragStart(U),c.connectPointDragMove(V),c.connectPointDragEnd(X),c.connectPointMouseUp(W),d}function v(a){var b=j.forItem(a);b.render(a)}function w(a,b){if(b.isLine)u(b);else{if(!b.isNode)throw new Error("Unexpected item, kind='{kind}'.".supplant({kind:b.kind}));t(b)}v(n.itemForData(b))}function x(a,b){var c=n.itemForData(b);c.view.remove(),n.remove(c)}function y(a){v(n.itemForData(a))}function z(a){v(n.itemForData(a))}function A(a){o.clear()}function B(a){var b=n.itemForView(a);q||b.isSelected||o.select(b)}function C(a){var b=n.itemForView(a);q&&o.addOrRemove(b)}function D(a){}function E(a){console.log("onItemSelectionChange"),ab(),!o.isMultiple()&&a.isSelected?h.val(a.data.text):h.val("")}function F(a){console.log("onItemEditViewFocus"),_()}function G(a){console.log("onItemEditViewBlur"),ab()}function H(a){p=c.moveCommand(o.items())}function I(a,b,c){var d=bb({x:b,y:c});p.dx=d.x,p.dy=d.y,p.preview()}function J(a,b,c){p.cancelPreview();var d=bb({x:b,y:c});p.dx=d.x,p.dy=d.y,m.execute(p),p=null}function K(a){p=c.resizeNodeCommand(o.items())}function L(a,b,c){var d=bb({x:b,y:c});p.dWidth=d.x,p.dHeight=d.y,p.preview()}function M(a,b,c){p.cancelPreview();var d=bb({x:b,y:c});p.dWidth=d.x,p.dHeight=d.y,m.execute(p),p=null}function N(a,b,d){var e=n.itemForView(a).data;p=c.createLineCommand(g,e,b,d),r=!0}function O(a,b,c){var d=bb({x:b,y:c});p.x2=p.x1+d.x,p.y2=p.y1+d.y,p.preview()}function P(a,b,c){var d=n.itemForView(a).data;p.itemToConnect=d,p.x2=b,p.y2=c}function Q(a,b,c){p.cancelPreview(),m.execute(p),p=null,r=!1}function R(a){q&&a.showResizeBorder()}function S(a){a.hideResizeBorder(),a.hideConnectionPoints()}function T(a,b,c){var d=n.itemForView(a),e=j.forItem(d);if(!q){if(p&&p.isMoveCommand)return;e.showNearbyConnectionPoint(d.data,a,b,c,k)}}function U(a,b,d){a.hideConnectionPoints();var e=n.itemForView(a).data,f=e.pointAt(b,d);p=c.moveLinePointCommand(f)}function V(a,b,c){var d=bb({x:b,y:c});p.dx=d.x,p.dy=d.y,p.preview()}function W(a,b,c){var d=n.itemForView(a).data;p.itemToConnect=d.pointAt(b,c)}function X(a,b,c){p.cancelPreview(),m.execute(p),p=null}function Y(a){if(!r){var b=n.itemForView(a).data;a.showConnectionPoints(b.points())}}function Z(a){r||a.hideConnectionPoints()}function _(){p&&!p.isEditItemCommand&&(p=null),p||o.items().length===1&&(p=c.editItemCommand(o.items(0)))}function ab(){p&&p.isEditItemCommand&&(p.newText=h.val(),p.hasChanged()&&(m.execute(p),p=null))}function bb(a){var b=function(a,b){var c=Math.floor(a/b)*b,d=c+b;return Math.abs(a-d)<Math.abs(a-c)?d:c};return a.x=b(a.x,k),a.y=b(a.y,k),a.width&&(a.width=b(a.width,k)),a.height&&(a.height=b(a.height,k)),a}function cb(){var a=[];return{addOrRemove:function(a){a.isSelected?this.remove(a):this.add(a)},add:function(b){a.push(b),b.isSelected=!0,E(b),v(b)},remove:function(b){var c=a.indexOf(b);a.splice(c,1),b.isSelected=!1,E(b),v(b)},select:function(a){this.clear();if(Array.isArray(a)){var b=this;a.forEach(function(a){b.add(a)})}else this.add(a)},clear:function(){var b;while(b=a.pop())b.isSelected=!1,E(b),v(b)},items:function(b){return arguments.length===0?a.slice():a[b]},isMultiple:function(){return a.length>1}}}var i=a("utils"),j={node:d.nodeRenderer(),"class":d.classNodeRenderer(),useCase:d.useCaseNodeRenderer(),line:d.lineRenderer(),forItem:function(a){var b=a.data.kind;if(!this[b])throw new Error("Unknown kind '{kind}'".supplant({kind:b}));return this[b]}},k=15,l={},m,n=[],o,p,q=!1,r=!0;return n.itemForView=function(a){var b;for(b=0;b<this.length;b++)if(this[b].view===a)return this[b];throw new Error("Item view not found.")},n.itemForData=function(a){var b;for(b=0;b<this.length;b++)if(this[b].data===a)return this[b];throw new Error("Item not found.")},n.remove=function(a){var b=n.indexOf(a);n.splice(b,1)},l._test={items:n},s(),l}}),define("main",["require","exports","module","model","view","presenter/diagramPresenter"],function(a,b,c){var d=a("model"),e=a("view"),f=a("presenter/diagramPresenter");$(document).ready(function(){$("#demo").height($(document).height());var a=d.diagram();a.addItem(d.node({x:30,y:30,width:180,height:90,text:"simple node"})),a.addItem(d.node({x:255,y:30,width:180,height:135,text:"class\n--\n- property1\n- property2\n--\n+ doSomething()\n{{fill=#7fffd4}}",kind:"class"})),a.addItem(d.node({x:30,y:210,width:180,height:90,text:"use-case\n{{fill=lightgray}}",kind:"useCase"}));var b=e.rootView($("#diagram")),c=e.diagramView(b,a),g=$("#nodeEdit"),h=f(c,a,g);$("#addNode").click(function(){a.addItem(d.node())}),$("#addClass").click(function(){a.addItem(d.node({kind:"class"}))}),$("#addUseCase").click(function(){a.addItem(d.node({kind:"useCase"}))})})})