define("model/diagram",["require"],function(a){return function(){var a={},b=[],c=[],d=[],e=!0,f=0;return a.addItem=function(c){if(!c.isLine&&!c.isNode)throw new Error("Only nodes and lines can be added to diagram");c.id=++f,c.isLine&&c.points().forEach(function(a){a.id=++f}),b.push(c),e&&a.fireItemAdded(c)},a.removeItem=function(c){if(!c.isLine&&!c.isNode)throw new Error("Only nodes and lines can be removed from diagram");var d=b.indexOf(c);if(d===-1)throw new Error("Item '{itemId}' not found in diagram.".supplant({itemId:c.id}));c.disconnect(),b.splice(d,1),c.id=null,c.isLine&&c.points().forEach(function(a){a.id=null}),e&&a.fireItemRemoved(c)},a.items=function(){return b},a.changeEventsEnabled=function(a){if(arguments.length===0)return e;e=a},a.itemAdded=function(a){c.push(a)},a.itemRemoved=function(a){d.push(a)},a.fireItemAdded=function(b){c.forEach(function(c){c(a,b)})},a.fireItemRemoved=function(b){d.forEach(function(c){c(a,b)})},a.toJSON=function(){var a="[";return b.forEach(function(c,d){a+=c.toJSON(),d<b.length-1&&(a+=", ")}),a+="]",a},a}}),define("utils",["require"],function(a){return String.prototype.supplant||(String.prototype.supplant=function(a){return this.replace(/\{([^\{\}]*)\}/g,function(b,c){var d=a[c];return typeof d=="string"||typeof d=="number"?d:b})}),{objectWithId:function b(){return b.lastId||(b.lastId=0),b.lastId++,{oid:b.lastId}},addObservableProperty:function(a,b,c){Object.defineProperty(a,b,{get:function(){return a["__"+b]},set:function(c){var d=a["__"+b];a["__"+b]=c,c!==d&&a.changeEventsEnabled()&&a.fireChange()}}),a["__"+b]=c},copyShallow:function(a){return jQuery.extend({},a)},copyDeep:function(a){return jQuery.extend(!0,{},a)}}}),define("model/item",["require","utils"],function(a){return function(){var b=a("utils"),c=b.objectWithId(),d=[],e=[],f=!0;return c.id=null,c.change=function(a){e.push(a)},c.changeEventsEnabled=function(a){if(arguments.length===0)return f;f=a},c.fireChange=function(){e.forEach(function(a){a(c)})},c._addConnection=function(a){if(!a.id)throw new Error("Cannot add connection to item, it has no id set.");d.push(a),c.changeEventsEnabled()&&c.fireChange()},c.addConnection=function(a){c._addConnection(a),a._addConnection(c)},c._removeConnection=function(a){var b=d.indexOf(a);if(b===-1)throw new Error("Item '{itemId}' not found in connections of item '{thisId}'.".supplant({itemId:a.id,thisId:c.id}));d.splice(b,1),c.changeEventsEnabled()&&c.fireChange()},c.removeConnection=function(a){c._removeConnection(a),a._removeConnection(c)},c.connections=function(){return arguments.length===1?d[arguments[0]]:d.slice()},c.disconnect=function(){c.connections().forEach(function(a){c.removeConnection(a)})},c._test={onChangeHandlers:e},c}}),define("model/line",["require","model/item","utils"],function(a){var b=a("model/item"),c=a("utils");return function(a){function f(a,d){var e=b();return c.addObservableProperty(e,"x",a.x||0),c.addObservableProperty(e,"y",a.y||0),e.isLinePoint=!0,e.line=d,e.change=function(){throw new Error("You can't use change observing properties on point, use properties on line instead.")},e.fireChange=d.fireChange,e.changeEventsEnabled=function(){if(arguments.length!==0)throw new Error("You can't use change observing properties on point, use properties on line instead.");return d.changeEventsEnabled()},e}var d=b(),e=[];return a=a||{},e.push(f({x:a.x1||0,y:a.y1||0},d)),e.push(f({x:a.x2||0,y:a.y2||0},d)),c.addObservableProperty(d,"text",a.text||""),c.addObservableProperty(d,"kind",a.kind||"line"),d.points=function(a){return arguments.length===0?e.slice():e[a]},d.pointAt=function(a,b){for(var c=0;c<e.length;c++){var f=e[c];if(f.x===a&&f.y===b)return f}throw new Error("Point [{x}, {y}] not found on line with id '{line}'.".supplant({x:a,y:b,line:d.id}))},d.addConnection=function(a){throw new Error("You can't connect to line directly, use function on its point instead.")},d.removeConnection=function(a){throw new Error("You can't disconnect from line directly, use function on its point instead.")},d.connections=function(){throw new Error("You can't get list of line connections directly, use function on its point instead.")},d.disconnect=function(){d.points().forEach(function(a){a.connections().forEach(function(b){a.removeConnection(b)})})},d.isLine=!0,d}}),define("model/node",["require","model/item","utils"],function(a){var b=a("model/item"),c=a("utils");return function(a){var d=90,e=b();return a=a||{},c.addObservableProperty(e,"text",a.text||""),c.addObservableProperty(e,"x",a.x||0),c.addObservableProperty(e,"y",a.y||0),c.addObservableProperty(e,"width",a.width||d),c.addObservableProperty(e,"height",a.height||d),c.addObservableProperty(e,"kind",a.kind||"node"),e.moveTo=function(a,b){e.connections().forEach(function(c){if(!c.isLinePoint)throw new Error("Don't know how to handle item.");c.line.changeEventsEnabled(!0),c.x=c.x-e.x+a,c.y=c.y-e.y+b,c.line.changeEventsEnabled(!1),c.line.fireChange()}),e.x=a,e.y=b},e.move=function(a,b){e.moveTo(e.x+a,e.y+b)},e.resizeTo=function(a,b){e.changeEventsEnabled(!1),e.connections().forEach(function(c){if(!c.isLinePoint)throw new Error("Don't know how to handle item.");var d=!1;c.line.changeEventsEnabled(!0),c.x===e.x+e.width&&(c.x=e.x+a,d=!0),c.y===e.y+e.height&&(c.y=e.y+b,d=!0),c.line.changeEventsEnabled(!1),d&&c.line.fireChange()}),e.width=a,e.height=b,e.changeEventsEnabled(!0),e.fireChange()},e.isNode=!0,e}}),define("model",["require","model/diagram","model/line","model/node"],function(a){return{diagram:a("model/diagram"),line:a("model/line"),node:a("model/node")}}),define("view/svg/svgHelper",["require"],function(a){var b="http://www.w3.org/2000/svg";return{createSvgElement:function(a,c){var d=$(document.createElementNS(b,a));return c&&d.attr(c),d},pathBuilder:function(){var a=this.createSvgElement("path"),b="";return{moveTo:function(a,c){return b+="M {x} {y}".supplant({x:a,y:c}),this},lineTo:function(a,c){return b+="L {x} {y}".supplant({x:a,y:c}),this},attr:function(b){return a.attr(b),this},create:function(){return a.attr("d",b),a}}},printSvg:function(a){var b="",c;if(a.length)for(c=0;c<a.length;c++)b+=this.printSvg(a[c]);else{var d=a;if(!(d instanceof SVGElement))throw new Error("'{element}' is not a SVG element.".supplant({element:d}));b="<"+d.tagName;var e;for(c=0;c<d.attributes.length;c++)e=d.attributes[c],b+=' {name}="{value}"'.supplant(e);b+=">";for(c=0;c<d.childNodes.length;c++)b+=this.printSvg(d.childNodes[c]);b+="</"+d.tagName+">"}return b}}}),define("view/svg/viewBase",["require","./svgHelper"],function(a){return function(b){var c=a("./svgHelper"),d={},e,f,g,h;return b.click(function(a){a.stopPropagation(),e&&e(d)}),b.dblclick(function(a){a.stopPropagation(),f&&f(d)}),b.mousedown(function(a){a.stopPropagation(),g&&g(d)}),b.mouseup(function(a){h&&h(d)}),d.click=function(a){e=a},d.doubleClick=function(a){f=a},d.mouseDown=function(a){g=a},d.mouseUp=function(a){h=a},d.element=function(){return b},d.previewMove=function(a,c){b.attr("transform","translate({dx},{dy})".supplant({dx:a,dy:c}))},d.cancelPreviewMove=function(){b.removeAttr("transform")},d.createElement=function(a,d){var e=c.createSvgElement(a,d);return b.append(e),e},d.remove=function(){b.remove()},d}}),define("view/svg/rootView",["require","./viewBase","./svgHelper"],function(a){return function(b){var c=a("./viewBase"),d=a("./svgHelper"),e=$(d.createSvgElement("svg")),f=c(e);return b.append(e),f.containerWidth=function(){return b.width()},f.containerHeight=function(){return b.height()},f._test={svg:function(){return d.printSvg(e)}},f}}),define("view/svg/diagramView",["require","./viewBase","./svgHelper"],function(a){return function(b){function i(){g=f.createElement("rect",{"class":"eventBox",opacity:0,fill:"blue",width:"100%",height:"100%"}),h=f.createElement("g",{"class":"grid"}),e.css("-webkit-user-select","none"),e.css("-khtml-user-select","none"),e.css("-o-user-select","none"),e.css("user-select","none")}var c=a("./viewBase"),d=a("./svgHelper"),e=b.createElement("g",{"class":"diagram"}),f=c(e),g,h;return f.gridStep=0,f.update=function(){h.empty();if(f.gridStep!==0){var a=b.containerWidth(),c=b.containerHeight(),e,g,i;for(e=0;e<a;e+=f.gridStep)i=d.createSvgElement("line",{x1:e,y1:0,x2:e,y2:c,stroke:"blue",opacity:.5}),h.append(i);for(g=0;g<c;g+=f.gridStep)i=d.createSvgElement("line",{x1:0,y1:g,x2:a,y2:g,stroke:"blue",opacity:.5}),h.append(i)}},f.offset=function(){return b.element().offset()},i(),f}}),define("view/svg/dragEventHandler",["require"],function(a){return function(a){function k(a){i&&l(),i=$(a),i.data("events")&&i.data("events").click&&(j=i.data("events").click.slice()),i.off("click")}function l(){j&&(j.forEach(function(a){i.on(a.type,a.selector,a.data,a.handler)}),i=undefined,j=undefined)}var b=!1,c=!1,d,e,f,g,h;a.mousedown(function(a){d=a.clientX,e=a.clientY,b=!0}),$(document.body).mousemove(function(a){b&&(c=!0,b=!1,f&&f(a),k(a.target));if(c&&g){var h=a.clientX-d,i=a.clientY-e;g(a,h,i)}}),$(document).mouseup(function(a){b=!1;if(c){c=!1;if(h){var f=a.clientX-d,g=a.clientY-e;h(a,f,g)}$(a.target).one("click",function(a){a.stopImmediatePropagation()}),l()}});var i,j,m={dragStart:function(a){f=a},dragMove:function(a){g=a},dragEnd:function(a){h=a}};return m}}),define("view/svg/nodeView",["require","./viewBase","./svgHelper","./dragEventHandler"],function(a){return function(b){function C(){g.attr("cursor","move"),i=h.createElement("g",{"class":"content"}),j=h.createElement("rect",{"class":"eventBox",opacity:0,fill:"blue"}),k=h.createElement("g",{"class":"resize-border",display:"none"}),l=h.createElement("circle",{"class":"connect-point",cx:0,cy:0,r:0,fill:"red",stroke:"blue",display:"none"}),l.attr("cursor","default"),m=h.createElement("circle",{"class":"connect-point-locked",cx:0,cy:0,r:0,fill:"none",stroke:"black","stroke-width":2,display:"none"});var a=f(g);a.dragStart(function(a){!A&&!B&&n&&n(h)}),a.dragMove(function(a,b,c){!A&&!B&&o&&o(h,b,c)}),a.dragEnd(function(a,b,c){!A&&!B&&p&&p(h,b,c)});var c=f(l);c.dragStart(function(a){B=!0;if(t){var b=a.target.cx.animVal.value,c=a.target.cy.animVal.value;t(h,b,c)}}),c.dragMove(function(a,b,c){u&&u(h,b,c)}),c.dragEnd(function(a,b,c){B=!1,v&&v(h,b,c)}),l.mouseup(function(a){if(w){var b=a.target.cx.animVal.value,c=a.target.cy.animVal.value;w(h,b,c)}}),l.mouseenter(function(a){l.attr("fill","black")}),l.mouseleave(function(a){l.attr("fill","red")}),g.mouseenter(function(a){!A&&x&&x(h)}),g.mouseleave(function(a){!A&&y&&y(h)}),g.mousemove(function(a){if(!A&&z){var c=b.offset();z(h,a.pageX-c.left,a.pageY-c.top)}})}function D(a){k.empty(),k.append(e.createSvgElement("rect",{x:a.x-2,y:a.y-2,width:a.width+4,height:a.height+4,fill:"none",stroke:"black","stroke-dasharray":"4,4"}));var b=e.pathBuilder().moveTo(a.x+a.width,a.y+a.height-c).lineTo(a.x+a.width,a.y+a.height).lineTo(a.x+a.width-c,a.y+a.height).attr({"stroke-width":7,stroke:"red",opacity:0,fill:"none",cursor:"se-resize"}).create();k.append(b);var d=f(b);d.dragStart(function(a){A=!0,q&&q(h)}),d.dragMove(function(a,b,c){r&&r(h,b,c)}),d.dragEnd(function(a,b,c){A=!1,s&&s(h,b,c)})}function E(a){var b=e.createSvgElement("text",{x:a.x||0,y:a.y||0,"dominant-baseline":"text-before-edge"});return b.text(a.text),b}var c=15,d=a("./viewBase"),e=a("./svgHelper"),f=a("./dragEventHandler"),g=b.createElement("g",{"class":"node"}),h=d(g),i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=!1,B=!1;return h.dragStart=function(a){n=a},h.dragMove=function(a){o=a},h.dragEnd=function(a){p=a},h.resizeDragStart=function(a){q=a},h.resizeDragMove=function(a){r=a},h.resizeDragEnd=function(a){s=a},h.connectPointDragStart=function(a){t=a},h.connectPointDragMove=function(a){u=a},h.connectPointDragEnd=function(a){v=a},h.connectPointDrop=function(a){w=a},h.mouseEnter=function(a){x=a},h.mouseLeave=function(a){y=a},h.mouseMove=function(a){z=a},h.showResizeBorder=function(){k.attr("display","block")},h.hideResizeBorder=function(){k.attr("display","none")},h.showConnectionPoint=function(a){if(l.attr("cx")==a.x&&l.attr("cy")==a.y&&l.attr("display")==="block")return;l.attr({cx:a.x,cy:a.y,display:"block"}),$(l[0].r.baseVal).animate({value:10},{duration:"fast"})},h.hideConnectionPoints=function(){l.attr({display:"none"}),l.delay(500).queue(function(){l.attr({r:0})})},h.animateLock=function(){m.attr({cx:l.attr("cx"),cy:l.attr("cy"),r:40,display:"block"}),$(m[0].r.baseVal).animate({value:0},{duration:"fast"})},h.previewMove=function(a,b){g.attr("transform","translate({dx},{dy})".supplant({dx:a,dy:b}))},h.cancelPreviewMove=function(){g.attr("transform","")},h.updateBounds=function(a){D(a);var c=b.gridStep/3;j.attr({x:a.x-c,y:a.y-c,width:a.width+2*c,height:a.height+2*c})},h.isSelected=function(a){j.attr("opacity",a?.5:0)},h.clear=function(){i.empty()},h.rect=function(a){var b=e.createSvgElement("rect",a);i.append(b)},h.line=function(a){var b=e.createSvgElement("line",a);i.append(b)},h.ellipse=function(a){var b=e.createSvgElement("ellipse",a);i.append(b)},h.text=function(a){var b=E(a);return i.append(b),{width:b.width(),height:b.height()}},h.measureText=function(a){var b=E(a);i.append(b);var c={width:b.width(),height:b.height()};return b.remove(),c},h._test={},h._test.contentSvg=function(){var a="",b,c=i[0];for(b=0;b<c.childNodes.length;b++)a+=e.printSvg(c.childNodes[b]);return a},C(),h}}),define("view/svg/lineView",["require","./viewBase","./svgHelper","./dragEventHandler"],function(a){return function(b){function s(){h=g.createElement("g",{"class":"content"}),i=g.createElement("line",{"class":"eventBox",stroke:"blue",opacity:0,"stroke-width":b.gridStep/3*2}),j=g.createElement("g",{"class":"connect-points"}),j.attr("cursor","default"),f.mouseenter(function(a){!n&&p&&p(g)}),f.mouseleave(function(a){!n&&q&&q(g)}),f.mousemove(function(a){if(!n&&r){var c=b.offset();r(g,a.pageX-c.left,a.pageY-c.top)}});var a=e(j);a.dragStart(function(a){n=!0;if(k){var b=a.target.cx.animVal.value,c=a.target.cy.animVal.value;k(g,b,c)}}),a.dragMove(function(a,b,c){l&&l(g,b,c)}),a.dragEnd(function(a,b,c){n=!1,m&&m(g,b,c)}),j.mouseup(function(a){if(o){var b=a.target.cx.animVal.value,c=a.target.cy.animVal.value;o(g,b,c)}})}var c=a("./viewBase"),d=a("./svgHelper"),e=a("./dragEventHandler"),f=b.createElement("g",{"class":"line"}),g=c(f),h,i,j,k,l,m,n=!1,o,p,q,r;return g.connectPointDragStart=function(a){k=a},g.connectPointDragMove=function(a){l=a},g.connectPointDragEnd=function(a){m=a},g.connectPointDrop=function(a){o=a},g.mouseEnter=function(a){p=a},g.mouseLeave=function(a){q=a},g.mouseMove=function(a){r=a},g.updateBounds=function(a){i.attr(a)},g.isSelected=function(a){i.attr("opacity",a?.5:0)},g.showConnectionPoints=function(a){a.forEach(function(a){var b=d.createSvgElement("circle",{cx:a.x,cy:a.y,r:6,fill:"red",stroke:"blue"});j.append(b)})},g.hideConnectionPoints=function(){j.empty()},g.clear=function(){h.empty()},g.line=function(a){var b=d.createSvgElement("line",a);h.append(b)},s(),g}}),define("view/keyboard",["require"],function(a){return function(){var a={},b,c=!1;return $(document).keydown(function(a){a.which===17&&(c=!0)}),$(document).keyup(function(a){a.ctrlKey&&(c=!1),b&&b({ctrlKey:a.ctrlKey,which:a.which})}),$(window).blur(function(){c=!1}),a.keyUp=function(a){b=a},a.isCtrlKeyDown=function(){return c},a}}),define("view/itemEditView",["require"],function(a){return function(a){var b={},c,d;return b.text=function(b){if(arguments.length===0)return a.val();a.val(b)},b.focus=function(a){c=a},b.blur=function(a){d=a},a.focus(function(a){c&&c()}),a.blur(function(a){d&&d()}),b}}),define("view",["require","view/svg/rootView","view/svg/diagramView","view/svg/nodeView","view/svg/lineView","view/keyboard","view/itemEditView"],function(a){return{rootView:a("view/svg/rootView"),diagramView:a("view/svg/diagramView"),nodeView:a("view/svg/nodeView"),lineView:a("view/svg/lineView"),keyboard:a("view/keyboard"),itemEditView:a("view/itemEditView")}}),define("presenter/commands",["require","model"],function(a){var b=a("model");return{moveCommand:function(a){function e(b,c){a.forEach(function(a){if(a.item.isNode){var d=a.item;d.moveTo(d.x+b,d.y+c)}})}var b={},c=0,d=0;return b.dx=0,b.dy=0,b.isMoveCommand=!0,b.preview=function(){a.forEach(function(a){if(a.item.isNode){a.view.previewMove(b.dx,b.dy);var e=a.item;e.changeEventsEnabled(!1),e.move(b.dx-c,b.dy-d),e.changeEventsEnabled(!0)}}),c=b.dx,d=b.dy},b.cancelPreview=function(){a.forEach(function(a){if(a.item.isNode){a.view.cancelPreviewMove();var c=a.item;c.changeEventsEnabled(!1),c.move(-b.dx,-b.dy),c.changeEventsEnabled(!0)}})},b.execute=function(){e(b.dx,b.dy)},b.undo=function(){return e(-b.dx,-b.dy),a},b},resizeNodeCommand:function(a){function e(b,c){a.forEach(function(a){if(a.item.isNode){var d=a.item;d.resizeTo(d.width+b,d.height+c)}})}var b={},c=0,d=0;return b.dWidth=0,b.dHeight=0,b.isResizeNodeCommand=!0,b.preview=function(){e(b.dWidth-c,b.dHeight-d),c=b.dWidth,d=b.dHeight},b.cancelPreview=function(){e(-b.dWidth,-b.dHeight)},b.execute=function(){e(b.dWidth,b.dHeight)},b.undo=function(){return e(-b.dWidth,-b.dHeight),a},b},createLineCommand:function(a,c,d,e){var f={},g;return f.x1=d,f.y1=e,f.x2=d,f.y2=e,f.itemToConnect=null,g=b.line(),a.addItem(g),f.preview=function(){g.changeEventsEnabled(!1),g.points(0).x=f.x1,g.points(0).y=f.y1,g.points(1).x=f.x2,g.points(1).y=f.y2,g.changeEventsEnabled(!0),g.fireChange()},f.cancelPreview=function(){},f.execute=function(){g.changeEventsEnabled(!1),g.points(0).x=f.x1,g.points(0).y=f.y1,g.points(1).x=f.x2,g.points(1).y=f.y2,g.points(0).addConnection(c),f.itemToConnect&&g.points(1).addConnection(f.itemToConnect.item),g.changeEventsEnabled(!0),g.fireChange(),f.itemToConnect.view.hideConnectionPoints(),f.itemToConnect.view.animateLock()},f.undo=function(){return[]},f},moveLinePointCommand:function(a){function f(b,c){a.line.changeEventsEnabled(!1),a.x+=b,a.y+=c,a.line.changeEventsEnabled(!0),a.line.fireChange()}var b={},c=0,d=0,e;b.dx=0,b.dy=0,b.connectToItem=null;if(a.connections().length>1)throw new Error("More that one connection on point '{id}'.".supplant(a));return a.connections().length===1&&(e=a.connections(0)),b.preview=function(){f(b.dx-c,b.dy-d),c=b.dx,d=b.dy},b.cancelPreview=function(){f(-b.dx,-b.dy)},b.execute=function(){f(b.dx,b.dy),a.line.changeEventsEnabled(!1),e&&a.removeConnection(e),b.connectToItem&&a.addConnection(b.connectToItem),a.line.changeEventsEnabled(!0),a.line.fireChange()},b.undo=function(){return f(-b.dx,-b.dy),a.line.changeEventsEnabled(!1),e&&a.addConnection(e),b.connectToItem&&a.removeConnection(b.connectToItem),a.line.changeEventsEnabled(!0),a.line.fireChange(),[]},b},editItemCommand:function(a){var b={},c=a.text;return b.newText=c,b.isEditItemCommand=!0,b.execute=function(){a.text=b.newText},b.undo=function(){return a.text=c,[a]},b.hasChanged=function(){return b.newText!==a.text},b},deleteItemsCommand:function(a,b){var c={},d=[];return c.execute=function(){b.forEach(function(b){var c=b.item;c.isLine?c.points().forEach(function(a){a.connections().forEach(function(b){d.push({from:a,to:b})})}):c.connections().forEach(function(a){d.push({from:c,to:a})}),a.removeItem(c)})},c.undo=function(){return b.forEach(function(b){a.addItem(b.item)}),d.forEach(function(a){a.from.addConnection(a.to)}),b},c}}}),define("presenter/renderFilters",["require","utils"],function(a){var b=a("utils");return{renderFilterChain:function(a,c){var d;for(d=1;d<c.length;d++)c[d-1]._next=c[d];return c[d-1]._next=a,{rect:function(a){a=a?b.copyShallow(a):{},c[0].rect(a)},line:function(a){a=a?b.copyShallow(a):{},c[0].line(a)},text:function(a){return a=a?b.copyShallow(a):{},c[0].text(a)},measureText:function(a){return c[0].measureText(a)}}},relative:function(a,c){return{_next:null,rect:function(d){return d=b.copyShallow(d),d.x=d.x?d.x+a:a,d.y=d.y?d.y+c:c,this._next.rect(d)},line:function(d){return d=b.copyShallow(d),d.x1=d.x1?d.x1+a:a,d.y1=d.y1?d.y1+c:c,d.x2=d.x2?d.x2+a:a,d.y2=d.y2?d.y2+c:c,this._next.line(d)},text:function(d){return d=b.copyShallow(d),d.x=d.x?d.x+a:a,d.y=d.y?d.y+c:c,this._next.text(d)},measureText:function(a){return a=b.copyShallow(a),this._next.measureText(a)}}},verticalFlow:function(a){var c=3,d=c;return{_next:null,rect:function(a){throw a=b.copyShallow(a),new Error("Not implemented yet.")},line:function(a){a=b.copyShallow(a),a.y1||(a.y1=d),a.y2||(a.y2=d),this._next.line(a),d=Math.max(a.y1,a.y2)+c},text:function(e){e=b.copyShallow(e),e.y||(e.y=d);var f=e.align||"left",g;if(f==="center")g=this._next.measureText({text:e.text}),e.x=0,a>g.width&&(e.x=(a-g.width)/2);else{if(f==="right")throw new Error("TODO: not implemented yet.");e.x=e.x?e.x+c:c}return g=this._next.text(e),d=e.y+g.height+c,g},measureText:function(a){return a=b.copyShallow(a),this._next.measureText(a)}}}}}),define("presenter/renderers",["require","presenter/renderFilters"],function(a){function c(a){var b={lines:[],properties:{}},c=a.split("\n");return c.forEach(function(a){var c=a.match(/^\{\{([^=]+)=([^}]+)\}\}$/);c===null?b.lines.push(a):b.properties[c[1]]=c[2]}),b}var b=a("presenter/renderFilters"),d;return{rendererForItem:function(a){if(!d){d={node:this.nodeRenderer(),"class":this.classNodeRenderer(),useCase:this.useCaseNodeRenderer(),line:this.lineRenderer()};if(!d[a.kind])throw new Error("I don't have renderer for item with kind '{kind}'".supplant({kind:a.kind}))}return d[a.kind]},nodeRenderer:function(){var a={};return a.TEXT_PADDING=5,a._render=function(a){var b=a.item,d=a.view;d.clear(),d.updateBounds({x:b.x,y:b.y,width:b.width,height:b.height}),d.isSelected(a.isSelected);var e=c(b.text),f=e.properties.fill||"white",g=e.properties.stroke||"black";return{lines:e.lines,properties:e.properties,fillColor:f,strokeColor:g}},a.render=function(c){var d=a._render(c),e=c.item,f=c.view;f.rect({x:e.x,y:e.y,width:e.width,height:e.height,rx:3,ry:3,fill:d.fillColor,stroke:d.strokeColor});var g=b.renderFilterChain(f,[b.verticalFlow(e.width),b.relative(e.x,e.y)]);d.lines.forEach(function(a){g.text({text:a})})},a.showNearbyConnectionPoint=function(a,b,c,d,e){var f,g,h,i,j,k=[];Math.abs(c-a.x)<e&&(i=Math.floor(d/e)*e,j=i+e,k.push({x:a.x,y:i}),k.push({x:a.x,y:j})),Math.abs(c-(a.x+a.width))<e&&(i=Math.floor(d/e)*e,j=i+e,k.push({x:a.x+a.width,y:i}),k.push({x:a.x+a.width,y:j})),Math.abs(d-a.y)<e&&(g=Math.floor(c/e)*e,h=g+e,k.push({x:g,y:a.y}),k.push({x:h,y:a.y})),Math.abs(d-(a.y+a.height))<e&&(g=Math.floor(c/e)*e,h=g+e,k.push({x:g,y:a.y+a.height}),k.push({x:h,y:a.y+a.height}));var l=Infinity;k.forEach(function(a){var b=Math.pow(Math.abs(a.x-c),2)+Math.pow(Math.abs(a.y-d),2);b<l&&(f=a,l=b)}),f?b.showConnectionPoint(f):b.hideConnectionPoints()},a},classNodeRenderer:function(){var a=this.nodeRenderer();return a.render=function(c){var d=a._render(c),e=c.item,f=c.view;f.rect({x:e.x,y:e.y,width:e.width,height:e.height,rx:3,ry:3,fill:d.fillColor,stroke:d.strokeColor});var g=b.renderFilterChain(f,[b.verticalFlow(e.width),b.relative(e.x,e.y)]),h=!0;d.lines.forEach(function(a){a==="--"?(g.line({x1:0,x2:e.width,stroke:d.strokeColor}),h=!1):g.text({text:a,align:h?"center":"left"})})},a},useCaseNodeRenderer:function(){var a=this.nodeRenderer();return a.render=function(c){var d=a._render(c),e=c.item,f=c.view,g=e.width/2,h=e.height/2;f.ellipse({cx:e.x+g,cy:e.y+h,rx:g,ry:h,fill:d.fillColor,stroke:d.strokeColor});var i=b.renderFilterChain(f,[b.verticalFlow(e.width),b.relative(e.x,e.y)]),j=0,k=0;d.lines.forEach(function(a){j+=f.measureText({text:a}).height}),e.height>j&&(k=(e.height-j)/2),d.lines.forEach(function(a,b){b===0?i.text({y:k,text:a,align:"center"}):i.text({text:a,align:"center"})})},a},lineRenderer:function(){var a={};return a.render=function(a){var b=a.item,c=a.view;c.clear(),c.updateBounds({x1:b.points(0).x,y1:b.points(0).y,x2:b.points(1).x,y2:b.points(1).y}),c.isSelected(a.isSelected),c.line({x1:b.points(0).x,y1:b.points(0).y,x2:b.points(1).x,y2:b.points(1).y,stroke:"black"})},a}}}),define("presenter/commandExecutor",["require"],function(a){return function(){var a={},b=[];return a.execute=function(a){b.push(a),a.execute()},a.undo=function(a){if(b.length>0)return b.pop().undo()},a}}),define("presenter/diagramPresenter",["require","presenter/commands","presenter/renderers","presenter/commandExecutor","utils","view"],function(a){var b=a("presenter/commands"),c=a("presenter/renderers"),d=a("presenter/commandExecutor");return function(e,f,g,h){function t(){h||(h=a("view")),n=d(),q=db(),l=h.keyboard(),m=h.itemEditView(g);var b=h.rootView(f);o=h.diagramView(b),e.items().forEach(function(a){if(a.isNode)u(a);else{if(!a.isLine)throw new Error("Don't know what this item is: "+a.kind);v(a)}}),o.gridStep=j,o.update(),o.click(C),e.itemAdded(x),e.itemRemoved(y),m.focus(H),m.blur(I),l.keyUp(B),p.forEach(function(a){w(a)})}function u(a){var b=h.nodeView(o),c=i.objectWithId();return c.item=a,c.view=b,c.isSelected=!1,p.push(c),a.change(z),b.mouseDown(D),b.click(E),b.doubleClick(F),b.dragStart(J),b.dragMove(K),b.dragEnd(L),b.resizeDragStart(M),b.resizeDragMove(N),b.resizeDragEnd(O),b.connectPointDragStart(P),b.connectPointDragMove(Q),b.connectPointDragEnd(S),b.connectPointDrop(R),b.mouseEnter(T),b.mouseLeave(U),b.mouseMove(V),c}function v(a){var b=h.lineView(o),c=i.objectWithId();return c.item=a,c.view=b,c.isSelected=!1,p.push(c),a.change(A),b.mouseDown(D),b.click(E),b.doubleClick(F),b.mouseEnter($),b.mouseLeave(_),b.connectPointDragStart(W),b.connectPointDragMove(X),b.connectPointDragEnd(Z),b.connectPointDrop(Y),c}function w(a){var b=c.rendererForItem(a.item);b.render(a)}function x(a,b){if(b.isLine)v(b);else{if(!b.isNode)throw new Error("Unexpected item, kind='{kind}'.".supplant({kind:b.kind}));u(b)}w(p.forItem(b))}function y(a,b){var c=p.forItem(b);c.view.remove(),p.remove(c)}function z(a){w(p.forItem(a))}function A(a){w(p.forItem(a))}function B(a){if(a.ctrlKey===!0&&a.which===90){var c=n.undo();q.select(c)}if(a.which===46&&q.itemInfos().length>0){var d=b.deleteItemsCommand(e,q.itemInfos());n.execute(d)}}function C(a){q.clear()}function D(a){var b=p.forView(a);l.isCtrlKeyDown()||b.isSelected||q.select(b)}function E(a){var b=p.forView(a);l.isCtrlKeyDown()&&q.addOrRemove(b)}function F(a){}function G(a){bb(),!q.isMultiple()&&a.isSelected?m.text(a.item.text):m.text("")}function H(a){ab()}function I(a){bb()}function J(a){r=b.moveCommand(q.itemInfos())}function K(a,b,c){var d=cb({x:b,y:c});r.dx=d.x,r.dy=d.y,r.preview()}function L(a,b,c){r.cancelPreview();var d=cb({x:b,y:c});r.dx=d.x,r.dy=d.y,n.execute(r),r=null}function M(a){r=b.resizeNodeCommand(q.itemInfos())}function N(a,b,c){var d=cb({x:b,y:c});r.dWidth=d.x,r.dHeight=d.y,r.preview()}function O(a,b,c){r.cancelPreview();var d=cb({x:b,y:c});r.dWidth=d.x,r.dHeight=d.y,n.execute(r),r=null}function P(a,c,d){var f=p.forView(a).item;r=b.createLineCommand(e,f,c,d),s=!0}function Q(a,b,c){var d=cb({x:b,y:c});r.x2=r.x1+d.x,r.y2=r.y1+d.y,r.preview()}function R(a,b,c){r.itemToConnect=p.forView(a),r.x2=b,r.y2=c}function S(a,b,c){r.cancelPreview(),n.execute(r),r=null,s=!1}function T(a){}function U(a){a.hideResizeBorder(),a.hideConnectionPoints()}function V(a,b,d){l.isCtrlKeyDown()&&a.showResizeBorder();var e=p.forView(a),f=c.rendererForItem(e.item);if(!l.isCtrlKeyDown()){if(r&&r.isMoveCommand)return;f.showNearbyConnectionPoint(e.item,a,b,d,j)}}function W(a,c,d){a.hideConnectionPoints();var e=p.forView(a).item,f=e.pointAt(c,d);r=b.moveLinePointCommand(f)}function X(a,b,c){var d=cb({x:b,y:c});r.dx=d.x,r.dy=d.y,r.preview()}function Y(a,b,c){var d=p.forView(a).item;r.itemToConnect=d.pointAt(b,c)}function Z(a,b,c){r.cancelPreview(),n.execute(r),r=null}function $(a){if(!s){var b=p.forView(a).item;a.showConnectionPoints(b.points())}}function _(a){s||a.hideConnectionPoints()}function ab(){r&&!r.isEditItemCommand&&(r=null),r||q.itemInfos().length===1&&(r=b.editItemCommand(q.itemInfos(0).item))}function bb(){r&&r.isEditItemCommand&&(r.newText=m.text(),r.hasChanged()&&(n.execute(r),r=null))}function cb(a){var b=function(a,b){var c=Math.floor(a/b)*b,d=c+b;return Math.abs(a-d)<Math.abs(a-c)?d:c};return a.x=b(a.x,j),a.y=b(a.y,j),a.width&&(a.width=b(a.width,j)),a.height&&(a.height=b(a.height,j)),a}function db(){var a=[];return{addOrRemove:function(a){a.isSelected?this.remove(a):this.add(a)},add:function(b){a.push(b),b.isSelected=!0,G(b),w(b)},remove:function(b){var c=a.indexOf(b);a.splice(c,1),b.isSelected=!1,G(b),w(b)},select:function(a){this.clear();if(Array.isArray(a)){var b=this;a.forEach(function(a){b.add(a)})}else this.add(a)},clear:function(){var b;while(b=a.pop())b.isSelected=!1,G(b),w(b)},itemInfos:function(b){return arguments.length===0?a.slice():a[b]},isMultiple:function(){return a.length>1},length:function(){return a.length}}}var i=a("utils"),j=15,k={},l,m,n,o,p=[],q,r,s=!0;return p.forView=function(a){var b;for(b=0;b<this.length;b++)if(this[b].view===a)return this[b];throw new Error("Item view not found.")},p.forItem=function(a){var b;for(b=0;b<this.length;b++)if(this[b].item===a)return this[b];throw new Error("Item not found.")},p.remove=function(a){var b=p.indexOf(a);p.splice(b,1)},t(),k._test={itemInfos:p,selection:q},k}}),define("main",["require","exports","module","model","view","presenter/diagramPresenter"],function(a,b,c){var d=a("model"),e=a("view"),f=a("presenter/diagramPresenter");$(document).ready(function(){$("#demo").height($(document).height());var a=d.diagram();a.addItem(d.node({x:30,y:30,width:180,height:90,text:"simple node"})),a.addItem(d.node({x:255,y:30,width:180,height:135,text:"class\n--\n- property1\n- property2\n--\n+ doSomething()\n{{fill=#7fffd4}}",kind:"class"})),a.addItem(d.node({x:30,y:210,width:180,height:90,text:"important\nuse-case\n{{fill=lightgray}}",kind:"useCase"}));var b=f(a,$("#diagram"),$("#nodeEdit"));$("#addNode").click(function(){a.addItem(d.node())}),$("#addClass").click(function(){a.addItem(d.node({kind:"class"}))}),$("#addUseCase").click(function(){a.addItem(d.node({kind:"useCase"}))})})})